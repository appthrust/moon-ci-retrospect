import { readFile, stat } from "node:fs/promises";
async function main() {
    let anyErrors = false;
    const workspaceRoot = await getWorkspaceRoot();
    const ciReport = await readCiReport(workspaceRoot);
    if (!ciReport) {
        console.log("CI report file does not exist. No CI tasks may have been executed.");
        return anyErrors;
    }
    for (const action of ciReport.actions) {
        const taskInfo = taskInfoOf(action);
        if (!taskInfo) {
            continue;
        }
        const { stdout, stderr } = await readStatus({ workspaceRoot, taskInfo });
        const { project, task, command, status } = taskInfo;
        anyErrors = anyErrors || status === "failed";
        const target = `${project}:${task}`;
        writeGroup(`${statusBadges[status]} ${bold(target)}`, ({ println }) => {
            if (command) {
                println(blue(`$ ${command}`));
            }
            const hasStdout = stdout.trim() !== "";
            const hasStderr = stderr.trim() !== "";
            if (hasStdout) {
                println(stdoutBadge);
                println(stdout);
            }
            if (hasStderr) {
                println(stderrBadge);
                println(stderr);
            }
        });
    }
    return anyErrors;
}
async function getWorkspaceRoot() {
    return process.cwd();
}
async function readCiReport(workspaceRoot) {
    const ciReportPath = `${workspaceRoot}/.moon/cache/ciReport.json`;
    if (!(await fileExists(ciReportPath))) {
        return;
    }
    const ciReportFile = await readFileContent(ciReportPath);
    return JSON.parse(ciReportFile);
}
function taskInfoOf(action) {
    if (action.node.action !== "run-task") {
        return undefined;
    }
    const { project, task } = parseTarget(action.node.params.target);
    return {
        project,
        task,
        command: commandOf(action),
        status: action.status,
    };
}
function parseTarget(target) {
    const parts = target.split(":");
    const project = parts[0] ?? "unknown";
    const task = parts[1] ?? "unknown";
    return { project, task };
}
function commandOf(action) {
    for (const operation of action.operations) {
        if (operation.meta.type === "task-execution") {
            return operation.meta.command;
        }
    }
    return undefined;
}
async function readStatus({ workspaceRoot, taskInfo, }) {
    const { project, task } = taskInfo;
    const statusDir = `${workspaceRoot}/.moon/cache/states/${project}/${task}`;
    const stdoutPath = `${statusDir}/stdout.log`;
    const stderrPath = `${statusDir}/stderr.log`;
    const stdout = (await fileExists(stdoutPath)) ? await readFileContent(stdoutPath) : "";
    const stderr = (await fileExists(stderrPath)) ? await readFileContent(stderrPath) : "";
    return { stdout, stderr };
}
async function fileExists(path) {
    try {
        await stat(path);
        return true;
    }
    catch {
        return false;
    }
}
async function readFileContent(path) {
    return await readFile(path, { encoding: "utf8" });
}
function writeGroup(title, inner) {
    console.log(`::group::${title}`);
    inner({
        println(output) {
            console.log(output);
        },
    });
    console.log("::endgroup::");
}
const statusBadges = {
    passed: bgGreen(" PASS "),
    failed: bgRed(" FAIL "),
    skipped: bgBlue(" SKIP "),
};
function bgGreen(text) {
    return `\u001b[42m${text}\u001b[49m`;
}
function bgRed(text) {
    return `\u001b[41m${text}\u001b[49m`;
}
function bgBlue(text) {
    return `\u001b[44m${text}\u001b[49m`;
}
function bgDarkGray(text) {
    return `\u001b[48;5;236m${text}\u001b[49m`;
}
function bold(text) {
    return `\u001b[1m${text}\u001b[22m`;
}
function green(text) {
    return `\u001b[32m${text}\u001b[39m`;
}
function red(text) {
    return `\u001b[31m${text}\u001b[39m`;
}
function blue(text) {
    return `\u001b[34m${text}\u001b[39m`;
}
const stdoutBadge = bgDarkGray(`　${green("⏺")} STDOUT　`);
const stderrBadge = bgDarkGray(`　${red("⏺")} STDERR　`);
let anyErrors;
try {
    anyErrors = await main();
}
catch (error) {
    console.error(error);
    process.exit(0);
}
if (anyErrors === true) {
    console.error("Some tasks failed. Please check the output above.");
    process.exit(1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWxELEtBQUssVUFBVSxJQUFJO0lBQ2xCLElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQztJQUV0QixNQUFNLGFBQWEsR0FBRyxNQUFNLGdCQUFnQixFQUFFLENBQUM7SUFDL0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvRUFBb0UsQ0FBQyxDQUFDO1FBQ2xGLE9BQU8sU0FBUyxDQUFDO0lBQ2xCLENBQUM7SUFDRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2QyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2YsU0FBUztRQUNWLENBQUM7UUFDRCxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDekUsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQztRQUNwRCxTQUFTLEdBQUcsU0FBUyxJQUFJLE1BQU0sS0FBSyxRQUFRLENBQUM7UUFDN0MsTUFBTSxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksSUFBSSxFQUFFLENBQUM7UUFDcEMsVUFBVSxDQUFDLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFB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